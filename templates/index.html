<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendly-like Scheduler</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <h1>Schedule Your Appointment</h1>
    </header>

    <main class="container">
        <!-- Calendar Section -->
        <div class="calendar-section">
            <h2>Select a Date</h2>
            <select id="date-picker"></select>
        </div>

        <!-- Time Slots Section -->
        <div class="slots-section">
            <h2>Available Times</h2>
            <div id="slots-grid" class="slots-grid"></div>
        </div>

        <!-- Booking Confirmation Modal -->
        <div id="confirmation-modal" class="modal hidden">
            <div class="modal-content">
                <h3>Confirm Appointment</h3>
                <p id="selected-time"></p>
                <form id="booking-form">
                    <label for="alias">Your Amazon Alias:</label>
                    <input type="text" id="alias" name="alias" required>
                    <button type="submit">Confirm</button>
                </form>
                <button onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </main>

    <footer>
        &copy; 2024 DEN2 Amcare Scheduler
    </footer>

    <script>
        const datePicker = document.getElementById("date-picker");
        const slotsGrid = document.getElementById("slots-grid");
        const modal = document.getElementById("confirmation-modal");
        const selectedTimeText = document.getElementById("selected-time");
        const bookingForm = document.getElementById("booking-form");
        let selectedTime = "";

        // Fetch and render time slots for the selected date
        async function fetchSlots(date) {
            const res = await fetch(`/get_slots?date=${date}`);
            const slots = await res.json();
            slotsGrid.innerHTML = ""; // Clear previous slots

            slots.forEach(slot => {
                const button = document.createElement("button");
                button.textContent = slot.time;
                button.className = slot.associates.length >= 2 ? "slot full" : "slot available";

                if (slot.associates.length < 2) {
                    button.onclick = () => openModal(slot.time, date);
                }

                slotsGrid.appendChild(button);
            });
        }

        function openModal(time, date) {
            selectedTime = time;
            selectedTimeText.textContent = `Date: ${date}, Time: ${time}`;
            modal.classList.remove("hidden");
        }

        function closeModal() {
            modal.classList.add("hidden");
        }

        // Submit booking
        bookingForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const alias = document.getElementById("alias").value;
            const date = datePicker.value;

            const res = await fetch("/book_slot", {
                method: "POST",
                body: new URLSearchParams({ alias, time: selectedTime, date })
            });

            const message = await res.json();
            alert(message.message);
            closeModal();
            fetchSlots(date);
        });

        window.onload = () => {
            fetch('/').then(() => {
                const dates = {{ dates | safe }};
                dates.forEach(date => {
                    const option = new Option(date, date);
                    datePicker.add(option);
                });
                datePicker.value = dates[0];
                fetchSlots(dates[0]);
            });

            datePicker.addEventListener("change", () => {
                fetchSlots(datePicker.value);
            });
        };
    </script>
</body>
</html>
